# findONTime

**A tool to upload Fastq files to the INSaFLU database and perform metagenomics pathogen detection**

_Motivation_:

Reducing the time needed for pathogen detection and the sequencing costs per sample is crucial in the context of diagnostics using metagenomics sequencing. In fact, when performing hypothesis-free viral diagnosis by sequencing complex biological samples, the proportion of the virus in a sample is unknown. As such, the amount of sequencing data, and consequently run length, needed to accurately detect the virus cannot be predicted a priori. [name of the tool] runs concurrently with MinION sequencing and monitors the FASTQ files that are being generated in real-time for each sample, merges the files (at user defined time intervals), uploads them to the INSaFLU-TELEVIR platform and launches the metagenomics virus detection analysis using the TELEVIR module. This allows users to detect a virus in a sample as early as possible during the sequencing run, reducing the time gap between obtaining the sample and the diagnosis, and also reducing sequencing costs (as ONT runs can be stopped at any time and the flow cells can be cleaned and reused). [name of the tool] can be used as a “start-to-end” solution or for particular tasks (e.g., merging ONT output files, metadata preparation and upload to INSaFLU-TELEVIR).

## Introduction

The _insaflu-upload_ tool uploads fastq files to the INSaFLU database, and performs metagenomics pathogen detection. The tool relies on _fastq_handler_, a package to monitor and process Minion outputs.

The tool uploads the files generated by _fastq_handler_ to the insaflu database and performs metagenomics pathogen detection. It then generates a report with the results.

## Details

The user has the option to only upload the last file generated, or to upload all files generated by _fastq_handler_.

For upload, metadata files are generated for each sequence file. metadata files are stored in the metadata directory following the input directory structure. Metadata and Output directories are specified by the user can be the same.

### Upload

_insaflu-upload_ can interact with the INSaFLU in two ways:

- **Docker**. The user needs to have docker installed and running. The tool will then upload the files to the docker image. The user needs to provide the name of the docker image and the path for uploads.

- **SSH**. The user needs to have access to the database server. The tool will then upload the files to the database using SSH. The user needs to provide the path for uploads and the credentials for the database server.

### INSaFLU

THe tool creates one INSaFLU-TELEVIR project for each directory containing fastq files. The project name is the name of the directory. Files generated within the same directory are uploaded to the same project.

### Input Files

- **fastq.gz** - Output directory for the ONT run, containing sequence files. The files can be in subfolders. The files can be gzipped or not.

- **config.ini** - A configuration file containing the parameters for the tool. The file is generated by the tool when it is run for the first time. The user can edit the file to change the parameters.

Config must contain:

- section [INSAFLU] containing insaflu username and app directory path.

- (optional) section [SSH] containing ssh credentials: username, ip_address and rsa key;

- (optional) section [DOCKER] containing docker image name.

see example [config.ini](config.ini)

## USAGE

```bash

usage: main_influ.py [-h] -i IN_DIR -o OUT_DIR [-t TSV_T_N] -d TSV_T_DIR [-s SLEEP] [-n TAG] [--config CONFIG] [--merge] [--upload {last,all}] [--connect {docker,ssh}] [--keep_names]

Process fastq files.

optional arguments:
-h, --help            show this help message and exit
-i IN_DIR, --in_dir IN_DIR
                        Input directory
-o OUT_DIR, --out_dir OUT_DIR
                        Output directory
-t TSV_T_N, --tsv_t_n TSV_T_N
                        TSV template name
-d TSV_T_DIR, --tsv_t_dir TSV_T_DIR
                        TSV template directory
-s SLEEP, --sleep SLEEP
                        Sleep time between checks in monitor mode
-n TAG, --tag TAG     name tag, if given, will be added to the output file names
--config CONFIG       config file
--merge               merge files
--upload {last,all}   file upload strategy (default: all)
--connect {docker,ssh}
                        file upload stategy (default: ssh)
--keep_names          keep original file names
--monitor	monitor directory until killed


```

# findONTime

## How to run

### 1. Install the tool

```bash
git clone
cd insaflu-upload
python -m venv .venv
source .venv/bin/activate
python -m pip install -r requirements.txt
```

### 2. Run the tool

run concurrently with minion

```bash
python main_influ.py -i test_run/ -o test_new -d test_new --tag another -s 5 --merge

```

run just upload

### 3. REQUIREMENTS

** Modules **

- **python 3.6** or higher
- dataclasses==0.6
- natsort==8.3.1
- pandas==1.5.3
- paramiko==3.1.0
- pip==21.2.3
- setuptools==57.4.0
- xopen==1.7.0

### 4. INSTALLATION

    ```bash
    git clone
    cd insaflu-upload
    python -m venv .venv
    source .venv/bin/activate
    python -m pip install -r requirements.txt
    ```

### 5. USAGE

    ```bash
    python main_influ.py -i test_run/ -o test_new -d test_new --tag another -s 5 --merge

    ```

### 6. OUTPUT

> **Note:** The output directory structure is maintained.

- **fastq.gz** files containing all reads from the previous files.
- **log.txt** file containing the concatenation process.
- **metadata** individual metadata files for each fastq file uploaded.
- **results.tsv** file containing the results of the pathogen detection. One file per project.

## Maintainers

- [**@santosjgnd**](https://github.com/SantosJGND)
- [**@insaflu**](https://github.com/insapathogenomics)
